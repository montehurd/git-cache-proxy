daemon off;
worker_processes auto;

user nginx nginx;

events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;

    client_max_body_size 0;
    client_body_buffer_size 512k;
    
    upstream fcgiwrap {
        server unix:/var/run/fcgiwrap.socket;
    }

    error_log /dev/stderr warn;

    server {
        listen 8765;
        access_log /dev/stdout;
        error_log /dev/stderr warn;
        server_name localhost;

        location ~ .*/(?:info/refs|git-upload-pack)$ {
            error_log /dev/stderr warn;

            # Increase buffer sizes
            fastcgi_buffering on;
            fastcgi_buffers 64 128k;        # More buffers (8MB total)
            fastcgi_buffer_size 256k;       # Initial buffer
            fastcgi_busy_buffers_size 512k; # Larger busy buffers
            fastcgi_temp_file_write_size 256k;
            fastcgi_max_temp_file_size 0;   # Unlimited temp file size

            # TCP optimizations
            tcp_nodelay on;
            tcp_nopush on;

            # Other settings remain same
            fastcgi_read_timeout 300;
            fastcgi_send_timeout 300;
            fastcgi_pass fcgiwrap;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME /usr/local/bin/git-cache-handler.sh;
            fastcgi_param PATH_INFO $uri;
            fastcgi_param GIT_PROJECT_ROOT /repo-cache;
            fastcgi_param GIT_HTTP_EXPORT_ALL "1";
            fastcgi_param REQUEST_METHOD $request_method;
            fastcgi_param QUERY_STRING $query_string;
            fastcgi_intercept_errors on;
        }
    }
}